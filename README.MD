# ThinkPHP电商项目（2019-10-17 — 2019-11-10 八天课程，你他妈整整用了25天，你他妈整形）
### 1、项目状态码定义
* （1）1001：该字段是必填项
### 2、项目部署
* （1）配置apache虚拟主机，指向项目根目录下的wwwroot文件夹
* （2）把项目的入口文件放在wwwroot目录下
* （3）重要的核心代码（如TP框架的核心代码）放在跟wwwroot目录同级部署，会让项目安全性更高
* （4）修改TP框架的入口文件的相关目录：
``` php
  // 定义应用存储目录
  define('APP_PATH','../Application'.DS);
  // 引入ThinkPHP入口文件
  require '../ThinkPHP/ThinkPHP.php';
```
* （5）运行项目，初始化项目目录，项目本地环境搭建完成
### 3、项目URL访问地址优化
* （1）隐藏项目的入口文件，借助apache的重写机制实现（已开启），并修改TP的URL访问模式为重写模式（好像不能限制访问模式）
``` php
'URL_MODEL'             =>  2,       // URL访问模式,可选参数0、1、2、3,代表以下四种模式：
  // 0 (普通模式); 1 (PATHINFO 模式); 2 (REWRITE  重写模式); 3 (兼容模式)  默认为PATHINFO 模式
```
* （2）隐藏项目的Home(或者admin)模块,直接修改配置项即可
``` php
  // 这样配置以后，U函数生成的地址也会自动隐藏入口文件及默认模块名称
  'DEFAULT_MODULE'        =>  'Admin',  // 默认模块
  'DEFAULT_CONTROLLER'    =>  'Index', // 默认控制器名称
  'DEFAULT_ACTION'        =>  'index', // 默认操作名称
  'MODULE_ALLOW_LIST'     =>  array('Admin','Home'), // 设置容许访问的模块（好像主配置文件里面没有,但是配置有效）
```
### 4、数据表创建的常用原则
* （1）每张表都需要有一个主键标识
* （2）每个字段尽量设置为不允许为空然后给上默认值
* （3）每个字段的数据类型根据业务逻辑尽量选择小的类型
### 5、扩展TP中的类
* （1）用链式继承的方式实现扩展
### 6、创建数据模型
* （1）每次创建模型类建议在模型中自定义表字段，提高性能
* （2）创建自动验证插入的表字段，提高数据安全
### 7、修改无限级分类出现的BUG
* （1）如果将自己设置为自己的父分类
* （2）将父分类设置为自己的子分类
* （3）将自己的父分类设置为自己及自己下的所有的子分类
### 8、商品入库中常见的问题
* （1）商品写入时没有自定生成时间
  > * 使用模型的自动完成及钩子函数解决
  ``` php
    // 在模型中使用钩子函数补齐参数
      public function _before_insert(&$data, $options)
      {
        $data['addtime'] = time();
        if ($data['goods_sn']) {
          $res = $this->where("goods_sn = {$data['goods_sn']}")->find();
          if ($res) {
            $this->error = '商品货号已存在，请从新输入';
            return false;
          }
        } else {
          $data['goods_sn'] = 'wj'.uniqid();
        }
        dump($data);
      }
  ```
* （2）没有对货号进行处理，货号不能重复以及用户不输入货号时自动生成唯一的货号
  > * 使用模型的自动完成及钩子函数解决
``` php
    // 在模型中使用钩子函数补齐参数
      public function _before_insert(&$data, $options)
      {
        $data['addtime'] = time();
        if ($data['goods_sn']) {
          $res = $this->where("goods_sn = {$data['goods_sn']}")->find();
          if ($res) {
            $this->error = '商品货号已存在，请从新输入';
            return false;
          }
        } else {
          $data['goods_sn'] = 'wj'.uniqid();
        }
        dump($data);
      }
  ```
### 9、商品扩展分类
* 商品分类的作用就是为了帮助用户快速的找到自己想要购买的商品，因此一个商品都归属于某一个分类，有时有些商品希望在多个分类下显示，因此都可以给商品设置扩展分类来实现
### 10、商品列表的搜索分析
* （1） 搜索功能的本质就是一个表单提交给当前的URL地址时，当接收到搜索的条件后，在根据具体的搜索条件拼接出MySQL查询语句的where条件即可。
* （2）商品查询分三种情况：
   > * 根据提交的分类ID标识查询出商品表中的category_id值等于该ID标识的即可
   > * 根据提交的分类ID标识先查询出该分类下的所有子分类，然后在将提交的的分类id与该分类所对应的子分类进行组合作为条件进行查询，此时可以使用MySQL中的in语法进行查询
   > * 查询出商品的扩展分类的id等于当前分类或者是当前分类所对应的子分类，此时能够得到商品ID然后再根据商品ID获取对应的商品信息
### 11、权限控制介绍
* （1）权限就是是否能够访问某个页面，而某个页面对应代码中就是具体的方法，通过代码控制不同的管理员是否能够访问某个方法的过程就是权限控制
* （2）当前经常使用的权限控制方式就是使用RBAC的方式实现权限控制
### 12、RBAC方式权限控制
* （1）其是基于角色的权限控制方式，一个管理员属于某种角色，而某种角色具备了多个操作权限，因此管理员也具备了角色所对应的权限
### 12、RBAC具体要实现的功能
* （1）实现用户的管理功能（实现对用户的增删改查）
* （2）实现角色的管理功能（实现对角色的增删改查）
* （3）实现权限的增删改查（对于权限的增删改查一般都是有开发者实现的）
* （4）实现能够给用户赋予角色
* （5）实现能够给角色赋予权限
* （6）根据用户的角色不同显示出不同的导航菜单方便用户进行操作
* （7）针对所有用户的每一个访问都进行判断是否能够访问
* （8）预留一个默认的超级管理员管理角色（防止突发情况）
* （9）预留一个超级管理员的用户（不能够删除）
### 14、权限表的设计
* （1）权限名称
* （2）模型控制器方法的名称
* （3）上级权限的ID
* （4）设置是否显示
### 15、权限认证实现分析
* （1）第一步：实现管理员能够登陆到后台，当用户登陆成功后可以使用cookie记录用户的状态
* （2）第二步：针对所有控制器下的方法都进行判断是否已经登陆，在公共控制器的构造方法中对cookie的数据进行验证
* （3）第三步：对所有的方法都判断当前用户是否具备访问的权限,首先获取得到当前用户对应的角色信息，如果默认是超级管理员就不进行权限认证，否则需要对权限进行认证
   > * 超级管理员直接忽略权限认证
   > * 普通管理员，通过普通管理员所对应的角色信息获取其应有的权限下信息，将从数据库中获取到的权限信息的二维数组按照格式：
   平台->控制器->方法组合成一个一维数组，在把当前请求的URL地址按照平台->控制器->方法的格式组合成一个字符串，
   然后跟前面的一维数组进行比较，如果存在，则说明有权访问，否则无权访问
* （4）第四步：实现根据不同的管理员登陆显示不同的导航菜单
   > * 对于超级管理员获取所有的权限信息
   > * 对于普通管理员获取角色所对应的权限下信息
   > * 将权限信息赋值给模板，由模板进行显示
### 15、权限认证实现
* （1）新增属性保存登陆用户的信息（用户信息，用户权限信息，用户角色信息）
* （2）根据用户信息查询用户角色信息（区分超级管理员跟普管理员的区别）
* （3）根据用户角色信息查新并保存权限信息（区分超级管理员跟普管理员的区别）
### 16、权限认证优化
* 常见的MySQL优化技术有：
  > * MySQL读写分离
  > * MySQL分布式数据库搭建
  > * 在满足项目需求的情况下尽量减少对MySQL数据库的读写
* （1）在项目进行优化时问题最多的就在MySQL上
* （2）在对MySQL进行数据查询优化时有一个原则就是：能够避免从MySQL中查询数据的就尽量避免
* （3）在用户信息的事情上既需要查询数据由需要避免MySQL查询时，可以通过其他的数据存储介质保存用户的信息
* （4）常见的存储介质有：文件存储及内存存储等方式
* （5）本项目使用的存储介质是文件存储的方式储存，具体实现步骤：
  > * 当需要获取用户信息时，在从数据库获取信息之前，先到当前用户对应的文件中读取信息
  > * 如果读取到数据就直接使用，否则在到MySQL中读取信息然后在将信息写入到文件中，方便下次使用
  > * 当某个角色对应的权限信息发生变化时，需要将当前角色下的所有用户的文件信息全部删除，重新更新
* （6）实现缓存的过程：
  > * 先从缓存文件中获取对应用户的信息
  > * 根据获取到的用户信息判断是否需要进行数据库获取
  > * 如果拿到用户信息就不用数据库，否则读取数据库成功后把用户信息写入缓存
### 17、客户密码的“密码盐”加密步骤
* （1）先将用户密码进行一次MD5加密得到密文
* （2）将得到的密文与随机的生成的字符串（密码盐）进行拼接
* （3）将密文与随机字符串拼接后的结果再次进行MD5加密，实现双重MD5加密
### 18、购物车实现分析
* （1）当用户已经登陆，获取获取到用户的标识信息，直接将数据存储到数据库中
* （2）当用户没有登陆，可以使用session或者cookie来保存用户信息，推荐使用cookie存储
### 19、购物车需要记录的数据
* （1）需要记录商品ID
* （2）需要记录购买商品对应的属性值的组合，如白色，13寸
* （3）需要记录用户的购买数量
* （4）同一商品，只要有一个属性不同，也需要单独存储，属性相同，直接加上数量
### 20、cookie存储数据
* （1）cookie存储购物车的数据需要跟数据库一致，因此数据格式是一个数组，但是cookie只能存储字符串，可以通过序列化或者使用json存储购物车
* （2）以数组存储数据比较麻烦，每次在添加商品进入购物车时都需要检查商品的属性组合对应的信息是否存在，如果属性都一样，直接更新数量，否则重新添加数
### 21、商品下单步骤
* （1）获取购物车中的信息
* （2）根据每一个商品及商品属性组合检查库存
* （3）向订单总表写入数据
* （4）向订单商品详情表写入具体数据
* （5）减少商品对应的库存量
* （6）清空购物车中的数据
